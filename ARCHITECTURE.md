# 🏗️ Архитектура проекта

## Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                    E-COMMERCE TELEGRAM BOT                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   bot.py    │    │ handlers.py │    │ keyboards.py│         │
│  │             │    │             │    │             │         │
│  │ • Main App  │◄──►│ • Messages  │◄──►│ • Inline    │         │
│  │ • Startup   │    │ • Callbacks │    │   Keyboards │         │
│  │ • Config    │    │ • States    │    │ • Navigation│         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│           │                   │                   │             │
│           ▼                   ▼                   ▼             │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    services.py                              │ │
│  │                                                             │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │ │
│  │  │ Category    │ │ Product     │ │ User        │           │ │
│  │  │ Service     │ │ Service     │ │ Service     │           │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘           │ │
│  │                                                             │ │
│  │  ┌─────────────┐ ┌─────────────┐                           │ │
│  │  │ Cart        │ │ Order       │                           │ │
│  │  │ Service     │ │ Service     │                           │ │
│  │  └─────────────┘ └─────────────┘                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│           │                                                       │
│           ▼                                                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    models.py                                │ │
│  │                                                             │ │
│  │  • Pydantic Models                                          │ │
│  │  • Data Validation                                          │ │
│  │  • Serialization                                            │ │
│  └─────────────────────────────────────────────────────────────┘ │
│           │                                                       │
│           ▼                                                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    database.py                              │ │
│  │                                                             │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │ │
│  │  │ Category    │ │ Product     │ │ User        │           │ │
│  │  │ Model       │ │ Model       │ │ Model       │           │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘           │ │
│  │                                                             │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │ │
│  │  │ CartItem    │ │ Order       │ │ OrderItem   │           │ │
│  │  │ Model       │ │ Model       │ │ Model       │           │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│           │                                                       │
│           ▼                                                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    DATABASE                                 │ │
│  │                                                             │ │
│  │  SQLite / PostgreSQL / MySQL                               │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Компоненты системы

### 1. bot.py - Основное приложение
- **Назначение**: Точка входа в приложение
- **Функции**:
  - Инициализация бота
  - Настройка обработчиков
  - Обработка ошибок
  - Запуск polling

### 2. handlers.py - Обработчики сообщений
- **Назначение**: Обработка входящих сообщений и callback'ов
- **Функции**:
  - Команды бота (/start, /help, /admin)
  - Callback queries (нажатия кнопок)
  - Текстовые сообщения
  - Управление состояниями пользователей

### 3. keyboards.py - Inline клавиатуры
- **Назначение**: Создание интерфейса для взаимодействия
- **Функции**:
  - Клавиатуры для категорий
  - Клавиатуры для товаров
  - Клавиатуры для корзины
  - Административные клавиатуры

### 4. services.py - Бизнес-логика
- **Назначение**: Содержит всю бизнес-логику приложения
- **Сервисы**:
  - **CategoryService**: Управление категориями
  - **ProductService**: Управление товарами
  - **UserService**: Управление пользователями
  - **CartService**: Управление корзиной
  - **OrderService**: Управление заказами

### 5. models.py - Pydantic модели
- **Назначение**: Валидация и сериализация данных
- **Функции**:
  - Валидация входных данных
  - Сериализация ответов
  - Типизация данных

### 6. database.py - Модели базы данных
- **Назначение**: ORM модели для работы с БД
- **Функции**:
  - Определение структуры БД
  - Связи между таблицами
  - Миграции

### 7. utils.py - Утилиты
- **Назначение**: Вспомогательные функции
- **Функции**:
  - Форматирование данных
  - Валидация
  - Логирование

## Поток данных

### 1. Обработка сообщения пользователя
```
Telegram → bot.py → handlers.py → services.py → database.py → DB
```

### 2. Ответ пользователю
```
DB → database.py → services.py → handlers.py → keyboards.py → Telegram
```

## Паттерны проектирования

### 1. Service Layer Pattern
- **services.py** содержит всю бизнес-логику
- Разделение ответственности между слоями
- Легкость тестирования

### 2. Repository Pattern
- Каждый сервис работает с определенной сущностью
- Инкапсуляция логики доступа к данным

### 3. Factory Pattern
- **KeyboardBuilder** создает клавиатуры
- Единая точка создания UI элементов

### 4. State Pattern
- Управление состояниями пользователей
- Различное поведение в зависимости от состояния

## Схема базы данных

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  categories │    │   products  │    │    users    │
├─────────────┤    ├─────────────┤    ├─────────────┤
│ id (PK)     │    │ id (PK)     │    │ id (PK)     │
│ name        │◄───┤ category_id │    │ telegram_id │
│ description │    │ name        │    │ username    │
│ is_active   │    │ price       │    │ first_name  │
│ created_at  │    │ stock_qty   │    │ last_name   │
└─────────────┘    │ is_active   │    │ phone       │
                   │ created_at  │    │ address     │
                   └─────────────┘    │ created_at  │
                            │         └─────────────┘
                            │                  │
                            ▼                  ▼
                   ┌─────────────┐    ┌─────────────┐
                   │ cart_items  │    │   orders    │
                   ├─────────────┤    ├─────────────┤
                   │ id (PK)     │    │ id (PK)     │
                   │ user_id     │    │ order_num   │
                   │ product_id  │    │ user_id     │
                   │ quantity    │    │ total_amt   │
                   │ created_at  │    │ status      │
                   └─────────────┘    │ delivery    │
                                      │ customer    │
                                      │ created_at  │
                                      └─────────────┘
                                             │
                                             ▼
                                    ┌─────────────┐
                                    │order_items  │
                                    ├─────────────┤
                                    │ id (PK)     │
                                    │ order_id    │
                                    │ product_id  │
                                    │ quantity    │
                                    │ price       │
                                    └─────────────┘
```

## Безопасность

### 1. Валидация данных
- Pydantic модели для валидации
- Проверка типов и форматов
- Санитизация входных данных

### 2. Авторизация
- Проверка прав администратора
- Изоляция данных пользователей
- Валидация Telegram ID

### 3. Обработка ошибок
- Try-catch блоки
- Логирование ошибок
- Graceful degradation

## Масштабируемость

### 1. Горизонтальное масштабирование
- Stateless архитектура
- Возможность запуска нескольких экземпляров
- Внешняя база данных

### 2. Вертикальное масштабирование
- Оптимизация запросов к БД
- Кэширование часто используемых данных
- Асинхронная обработка

### 3. Мониторинг
- Логирование всех операций
- Метрики производительности
- Алерты при ошибках

## Тестирование

### 1. Unit тесты
- Тестирование отдельных сервисов
- Мокирование зависимостей
- Покрытие кода

### 2. Интеграционные тесты
- Тестирование взаимодействия компонентов
- Тестовая база данных
- End-to-end сценарии

### 3. Тестовые данные
- Автоматическая генерация
- Изоляция тестов
- Очистка после тестов

---

**Архитектура спроектирована для обеспечения надежности, масштабируемости и простоты сопровождения.**
